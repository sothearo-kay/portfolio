---
import { getPosts } from "~/utils/blog"
import CommandPaletteLazy from "../command/CommandPaletteLazy.svelte"
import Separator from "../common/Separator.astro"
import SearchButton from "../SearchButton.svelte"
import ThemeToggle from "../ThemeToggle.astro"

const navItems = [
  { href: "/", text: "Home" },
  { href: "/blog", text: "Blog" },
  { href: "/projects", text: "Projects" },
]

const currentPath = new URL(Astro.request.url).pathname

function isActive(href: string) {
  const normalizedCurrent = currentPath === "/" ? "/" : currentPath.replace(/\/$/, "")
  const normalizedHref = href === "/" ? "/" : href.replace(/\/$/, "")
  return normalizedCurrent === normalizedHref
}

const allBlogPosts = await getPosts()
const posts = allBlogPosts.map(post => ({
  id: post.id,
  title: post.data.title,
}))
---

<header class="header" transition:name="header">
  <div class="wrapper">
    <nav class="nav">
      <ul class="nav-list">
        {navItems.map(item => (
          <li class="nav-item">
            <a href={item.href} class:list={["nav-link", { active: isActive(item.href) }]}>
              {item.text}
            </a>
          </li>
        ))}
      </ul>
    </nav>

    <Separator orientation="vertical" />

    <div class="actions">
      <SearchButton client:idle />
      <ThemeToggle />
    </div>
  </div>
  <CommandPaletteLazy {posts} client:idle />
</header>

<style>
  .header {
    position: sticky;
    top: calc(1rem + env(safe-area-inset-top, 0px));
    left: 0;
    width: 100%;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: calc(1rem + env(safe-area-inset-top, 0px));

    .wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 999px;
      background-color: var(--color-background-elevated-transparent);
      border: 1px solid var(--color-border-subtle);
      box-shadow: var(--shadow-header);
      backdrop-filter: blur(0);
    }

    .nav-list {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .nav-item {
      font-size: 14px;
      font-weight: 500;

      .nav-link {
        padding: 0.5rem;
        color: var(--color-accent-foreground);
        transition: color 0.2s ease;

        &:hover,
        &.active {
          color: var(--color-foreground);
        }
      }
    }

    .actions {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
  }
</style>
